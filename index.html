<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—Ç–∏–ª–∏—Ç—ã V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/bookscrap2024.appspot.com/o/uploaded%2Ffavicon-16x16.jpg?alt=media&token=c64ce178-c860-4688-a510-77289b0cb258">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; font-size: 1vw; display: flex; flex-direction: column; position: relative; min-height: 100vh;}
        .panel {
            width: 90%; margin: 0 auto; min-height: 85vh; background-color: rgb(220, 249, 254);
            border-radius: 0 0 10px 10px; display: flex; flex-direction: column;
            padding: 2vw; gap: 1vw; align-items: center; justify-content: center;
            display: none; 
        }
        h2 {color: rgb(13, 84, 97); margin-bottom: 2vw;}
        h2, p {text-align: center; }
        p {margin-top: 1vw; text-transform: uppercase;}
        p span {color: rgb(13, 84, 97); font-weight: 700;}
        .form-inner { width: 80%; display: flex; flex-direction: column; align-items: flex-end; padding-top: 3vw; }
        .form-elem { display: flex; gap: 2vw; align-items: center; }
        .form-elem:nth-child(3) { margin-right: 6.95vw; }
        input { font-size: 1.2vw; padding-left: 0.5vw; height: 2vw; }
        .btnHandler {display: flex; flex-direction: column; justify-content: center; align-items: center;}
        button {
            width: 10vw; height: 2vw; font-size: 1vw; margin-top: 2vw;
            cursor: pointer; background-color: rgb(33, 156, 177); border: none; font-weight: 700; color: #FFFFFF; border-radius: 10px;
        }
        button:hover { background-color: rgb(13, 84, 97); }
        .loading { width: 100%; height: 8vw; display: flex; justify-content: center; align-items: center; color: darkorange; }
        .noMatchMsg {color: rgb(13, 84, 97);}
        .not-match-button {
            width: 20vw; background-color: coral; color: #fff; position: absolute;
            bottom: 10vw; left: calc(50% - 10vw); display: none; 
        }
        .not-match-button:hover { background-color: rgb(248, 102, 49); }
        .btn-visible { display: block; }
        .navigationWrapper {
            width: 100%;
            padding: 0.5vw 5% 0 5%;
            display: flex;
            align-items: flex-end;
            gap: 2vw;
            font-size: 1vw;
            height: 3vw;
        }

        .navBtn {
            padding: 0;
            margin: 0;
            text-transform: uppercase;
            background-color: rgb(220, 249, 254);
            font-size: 0.8vw;
            width: 100%;
            border-radius: 10px 10px 0 0;
            color: black;
        }

        .navBtn:hover {
            background-color: rgb(191, 236, 244);
        }

        .navBtn i {
            color: rgb(33, 156, 177);
            margin-left: 0.3vw;
        }

        .visible {
            display: block !important;
        } 

        .unVisible {
            display: none;
        }

        .load {
            position: relative;
        }

        .imp {
            color: coral;
        }

        .underline {
          text-decoration: underline;
          font-weight: 700;
          background-color: coral;
          color: #fff;
        }

        .footer {
            width: 10vw;
            position: absolute;
            bottom: 0;
            left: calc(50% - 5vw);
            background-color: rgb(33, 156, 177);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 1.3vw;
            color: #fff;
            border-radius: 5px 5px 0 0;
        }

        .under {
            z-index: -1;
            display: block;
            position: absolute;
            left: 5%;
            top: 3vw;
        }

        /* –û–±. –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
        .form-inner-vert{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 3vw;
        }

        .form-inner-vert-inner {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
        }

         /* –û–±. –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ - –≤—ã–±–æ—Ä–æ—á–Ω–æ*/

        .colSum {
            width: 4vw;
        }

        .form-inner-vert-inner.form-inner-vert-c {
            gap: 1vw;
        }

        /* –ê–Ω–∞–ª–∏–∑ ctr*/

        .form-elem.form-elem-flex {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 0;
        }

        .form-elem-bottom p{
            margin-top: 0;
        }

        .form-elem-ctr {
            margin-top: 1.5vw;
        }

        .form-elem-flex input {
            height: 1.4vw;
            font-size: 0.9vw;
        }

        .form-elem-bottom p {
            font-size: 0.8vw;
            margin-top: 0.3vw;
        }


        /* –°–ø–∏–Ω–Ω–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç) */
        .spinner {
            position: absolute;
            top: calc(50% - 25px);
            left: calc(50% - 25px);
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255);
            border-top-color: rgb(33, 156, 177);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s ease-in-out;
        }

        .spinnerProcess {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255);
            border-top-color: rgb(33, 156, 177);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s ease-in-out;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    
    </style>
</head>
<body>
    <div class="navigationWrapper">
        <Button class="navBtn" id="repeatUtlBtn">–ü–æ–∏—Å–∫ –ø–æ–≤—Ç–æ—Ä–æ–≤  <i class="fa-solid fa-magnifying-glass"></i></Button>
        <Button class="navBtn" id="mergeVertUtl">–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤ (–í)  <i class="fa-solid fa-arrows-up-down"></i></Button>
        <Button class="navBtn" id="mergeHorUtlBtn">–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤ (–í–í)  <i class="fa-solid fa-arrow-down-up-lock"></i></i></Button>     
        <Button class="navBtn" id="ctrAsnalyticsBtn">–ê–Ω–∞–ª–∏–∑ CTR  <i class="fa-solid fa-chart-line"></i></Button>
    </div>
    <form class="findRepeat panel ">
        <h2>- –ü–û–ò–°–ö –ü–û–í–¢–û–†–û–í –í –§–ê–ô–õ–ê–• EXCEL -</h2>
        <p class="instructions">
            –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ <span class="imp underline">–ø–µ—Ä–≤–æ–º (A)</span> —Å—Ç–æ–ª–±—Ü–µ
            –∫–∞–∂–¥–æ–≥–æ –∏–∑ —Ñ–∞–π–ª–æ–≤
          </p>
          <p class="instructions">
            –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ –ø–µ—Ä–≤–æ–º —Ñ–∞–π–ª–µ - –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö –ø–æ—Å–ª–µ <span class="imp">"REPEAT-->"</span>
          </p>
        <div class="form-inner">
            <div class="form-elem">
                <label>–§–ê–ô–õ –° –†–ï–ó–£–õ–¨–¢–ê–¢–û–ú:</label>
                <input type="file" id="inputFirstFile">
            </div>
            <div class="form-elem">
                <label>–§–ê–ô–õ –°–†–ê–í–ù–ï–ù–ò–Ø:</label>
                <input type="file" id="inputSecFile">
            </div>
            <div class="form-elem">
                <label>–ò–ú–Ø –§–ê–ô–õ–ê (–†–ï–ó–£–õ–¨–¢–ê–¢):</label>
                <input type="text" id="fileName" placeholder="–ü—Ä–∏–º–µ—Ä: –∫–Ω–∏–≥–∏">
            </div>
        </div>
        <div class="btnHandler">
            <button type="button" class="load-button">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
            <button type="button" class="not-match-button">–°–ö–ê–ß–ê–¢–¨ –ù–ï–°–û–í–ü–ê–î–ï–ù–ò–Ø</button>
        </div>
        <div class="loading"></div>
    </form>
    <form class="mergeVertical panel">
        <h2>- –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ü–û–í–¢–û–†–û–í (–í–ï–†–¢–ò–ö–ê–õ–¨–ù–û) -</h2>
        <p class="instructions">–ü–†–û–ì–†–ê–ú–ú–ê –°–†–ê–í–ù–ò–í–ê–ï–¢ –ü–û <span class="imp">–ü–ï–†–í–û–ú–£</span> –°–¢–û–õ–ë–¶–£ –ò –°–£–ú–ú–ò–†–£–ï–¢ –î–ê–ù–ù–´–ï –° <span class="imp">2-–ì–û</span> –°–¢–û–õ–ë–¶–ê</p>
        <p class="instructions">–í–ê–ñ–ù–û! –î–ê–ù–ù–´–ï –î–û–õ–ñ–ù–´ –ù–ê–•–û–î–ò–¢–°–Ø –° <span class="imp">–í–¢–û–†–û–ô</span> –°–¢–†–û–ö–ò (–ü–ï–†–í–ê–Ø –°–¢–†–û–ö–ê –ü–£–°–¢–ê–Ø)</p>
        <div class="form-inner-vert">
            <div class="form-inner-vert-inner">
                <div class="form-elem">
                    <label for="inputFileMergeVert">–§–ê–ô–õ –î–õ–Ø –û–ë–†–û–ë–û–¢–ö–ò: </label>
                    <input type="file" id="inputFileMergeVert" />
                </div>
                <div class="form-elem">
                    <label for="fileNameMergeVert">–ò–ú–Ø –§–ê–ô–õ–ê - –†–ï–ó–£–õ–¨–¢–ê–¢: </label>
                    <input type="text" id="fileNameMergeVert" placeholder="–ü–†–ò–ú–ï–†: –∫–Ω–∏–≥–∏" />
                </div>
            </div>
            <button type="button" class="load-button-merge-vert">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
        </div>
        <div class="loadingMergeVert"></div>
    </form>
    <form class="mergeVertOption panel">
        <h2>- –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ü–û–í–¢–û–†–û–í (–í–ï–†–¢–ò–ö–ê–õ–¨–ù–û) - –í–´–ë–†–ê–ù–ù–´–ï –Ø–ß–ï–ô–ö–ò -</h2>
        <p class="instructions">–ü–†–û–ì–†–ê–ú–ú–ê –°–†–ê–í–ù–ò–í–ê–ï–¢ –ü–û <span class="imp">–ü–ï–†–í–û–ú–£</span> –°–¢–û–õ–ë–¶–£</p>
        <div class="form-inner-vert">
            <div class="form-inner-vert-inner form-inner-vert-c">
                <div class="form-elem">
                    <label for="inputFileMergeVertC">–§–ê–ô–õ –î–õ–Ø –û–ë–†–û–ë–û–¢–ö–ò: </label>
                    <input type="file" id="inputFileMergeVertC" />
                </div>
                <div class="form-elem">
                    <label for="inputSecFile"
                        >–° –ö–ê–ö–û–ì–û –°–¢–û–õ–ë–¶–ê –°–£–ú–ú–ò–†–û–í–ê–¢–¨ (–ú–ò–ù. - 2):
                    </label>
                    <input class="colSum" min="2" type="number" id="inputColSum" />
                    <label for="inputSecFile">–ü–û –ö–ê–ö–û–ô –°–¢–û–õ–ë–ï–¶ (–í–ö–õ.): </label>
                    <input class="colSum" min="2" type="number" id="inputColSumEnd" />
                </div>
                <div class="form-elem">
                    <label for="fileName">–ò–ú–Ø –§–ê–ô–õ–ê - –†–ï–ó–£–õ–¨–¢–ê–¢: </label>
                    <input type="text" id="fileNameMergeVertC" placeholder="–ü–†–ò–ú–ï–†: –∫–Ω–∏–≥–∏" />
                </div>
            </div>
            <button type="button" class="load-button-merge-vert-c">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
        </div>
        
        <div class="loadingMergeVertC"></div>
    </form>
    <form class="ctrAsnalytics panel">
        <h2>- –ê–ù–ê–õ–ò–ó –ö–õ–Æ–ß–ï–í–´–• –§–†–ê–ó –üO CTR (WILDBERRIES) -</h2>
        <p class="instructions">
            –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ <span class="imp">–ø–µ—Ä–≤–æ–º</span> —Å—Ç–æ–ª–±—Ü–µ, –∏ —Å—É–º–º–∏—Ä—É–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        </p>
        <div class="form-inner-vert">
            <div class="form-inner-vert-inner">
                <div class="form-elem">
                    <label for="inputFileCtrA">–§–ê–ô–õ –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò: </label>
                    <input type="file" id="inputFileCtrA" />
                </div>
                <div class="form-elem form-elem-ctr form-elem-flex">
                    <div class="form-elem-top">
                        <label for="inputColSum">–ì–†–ê–ù–ò–¶–ê –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ì–û CTR:</label>
                        <input class="colSum" type="number" id="inputColSumCtr" />
                        <label for="inputColSumEnd">–ì–†–ê–ù–ò–¶–ê –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ì–û CTR: </label>
                        <input class="colSum" type="number" id="inputColSumCtrEnd" />
                    </div>
                    <div class="form-elem-bottom">
                        <p><span class="imp">*</span> –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - 0</p>
                    </div>
                </div>
                <div class="form-elem form-elem-ctr">
                    <label for="fileNameCtr">–ò–ú–Ø –§–ê–ô–õ–ê - –†–ï–ó–£–õ–¨–¢–ê–¢: </label>
                    <input type="text" id="fileNameCtr" placeholder="–ü–†–ò–ú–ï–†: –∫–Ω–∏–≥–∏" />
                </div>
            </div>
            <button type="button" class="load-button-ctr">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
        </div>
    </form>
    <form class="load panel visible"></form>
    <form class="panel under"></form>
    <div class="footer">–£—Ç–∏–ª–∏—Ç—ãV2 V1.0</div>
<script>
    const inputFFSearchRepeat = document.getElementById("inputFirstFile");
    const inputSFSearchRepeat = document.getElementById("inputSecFile");
    const loadBtnSearchRepeat = document.querySelector(".load-button");
    const noMatchBtn = document.querySelector(".not-match-button");
    const loading = document.querySelector(".loading");
    const fileNameInput = document.querySelector("#fileName");
    const handleBtnsWrapper = document.querySelector(".navigationWrapper");

    handleBtnsWrapper.addEventListener("click", (event) => {
        const searchRepeatPanel = document.querySelector(".findRepeat");
        const mergeVerticalPanel = document.querySelector(".mergeVertical");
        const mergeVertOptionPanel = document.querySelector(".mergeVertOption");
        const ctrAsnalyticsPanel = document.querySelector(".ctrAsnalytics");
        const panels = [searchRepeatPanel, mergeVerticalPanel, mergeVertOptionPanel, ctrAsnalyticsPanel];
        panels.forEach((panel) => {
            panel.classList.remove("visible");
        });
        const loadPanel = document.querySelector(".load");
        loadPanel.classList.add("visible");
        const spinner = document.createElement("div");
        spinner.classList.add("spinner");
        loadPanel.appendChild(spinner);

        setTimeout(() => {
            loadPanel.classList.remove("visible");
            spinner.remove();
            sessionStorage.setItem("lastClicked", event.target.id);
            location.reload();
        }, 500);
    });

    window.addEventListener("load", function() {
        let lastClicked = sessionStorage.getItem("lastClicked");
        const loadPanel = document.querySelector(".load");
        const searchRepeatPanel = document.querySelector(".findRepeat");
        const mergeVerticalPanel = document.querySelector(".mergeVertical");
        const mergeVertOptionPanel = document.querySelector(".mergeVertOption");
        const ctrAsnalyticsPanel = document.querySelector(".ctrAsnalytics");
        if (lastClicked) {
            const panels = [searchRepeatPanel, mergeVerticalPanel, mergeVertOptionPanel, ctrAsnalyticsPanel];
            panels.forEach((panel) => {
                panel.classList.remove("visible");
            });
            loadPanel.classList.remove("visible");
            if (lastClicked === "repeatUtlBtn") {
                searchRepeatPanel.classList.add("visible");
            } else if (lastClicked === "mergeVertUtl") {
                mergeVerticalPanel.classList.add("visible");
            } else if (lastClicked === "mergeHorUtlBtn") {
                mergeVertOptionPanel.classList.add("visible");
            } else if (lastClicked === "ctrAsnalyticsBtn") {
                ctrAsnalyticsPanel.classList.add("visible");
            }
            sessionStorage.removeItem("lastClicked"); // –ß–∏—Å—Ç–∏–º, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å –Ω–∞–≤—Å–µ–≥–¥–∞
        } else {
            searchRepeatPanel.classList.add("visible");
            loadPanel.classList.remove("visible");
        }
    });

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            console.log(`üìÇ –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª: ${file.name}`);
            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                console.log(`‚úÖ –§–∞–π–ª ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω. –ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫: ${parsedData.length}`);
                resolve(parsedData);
            };
            reader.onerror = (error) => reject(error);
            reader.readAsArrayBuffer(file);
        });
    }

    async function processFiles() {
        const fileName = fileNameInput.value.trim();
        if (!fileName) return;

        console.log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...");
        const spinner = document.createElement("div");
        repeatQtt = 0;
        loading.innerHTML = "";
        noMatchBtn.style.display = "none";
        spinner.classList.add("spinnerProcess");
        loading.appendChild(spinner);

        try {
            let [dataArrFirstFile, dataArrSecondFile] = await Promise.all([
                readExcelFile(inputFFSearchRepeat.files[0]),
                readExcelFile(inputSFSearchRepeat.files[0])
            ]);


            let header = dataArrFirstFile[0]; // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            let resultArr = [];
            let notMatchArr = []; // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –Ω–µ—Å–æ–≤–ø–∞–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            let repeatQtt = 0;

            // –°–æ–∑–¥–∞—ë–º Set –∏–∑ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            let firstFileSet = new Set(dataArrFirstFile.slice(1).map(row => row[1]));

            console.log("üîé –ù–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ...");
            for (let i = 0; i < dataArrFirstFile.length; i++) {
                let row1 = dataArrFirstFile[i];
                let matchRow = dataArrSecondFile.find(row2 => String(row2[0]).trim() === String(row1[0]).trim());

                if (matchRow) {
                    row1.push("REPEAT-->");
                    row1.push(...matchRow);
                    repeatQtt++;
                }
                resultArr.push(row1);
            }

            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ø–µ—Ä–≤–æ–º —Ñ–∞–π–ª–µ
            for (let i = 1; i < dataArrSecondFile.length; i++) {
                let row2 = dataArrSecondFile[i];
                if (!firstFileSet.has(row2[0])) {
                    notMatchArr.push(row2);
                }
            }

            // console.log("–ù–µ—Å–æ–≤–ø–∞–≤—à–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã:", notMatchArr);
            console.log(`‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${repeatQtt}`);

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(
                workbook,
                XLSX.utils.aoa_to_sheet(resultArr),
                "Results"
            );
            XLSX.writeFile(workbook, `${fileName}.xlsx`);
            console.log(`üìÇ –§–∞–π–ª ${fileName}.xlsx —Å–æ—Ö—Ä–∞–Ω–µ–Ω.`);
            // loading.remove(spinner);
            loading.innerHTML = `<p class="noMatchMsg">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ: <span style="color:red; font-weight:700;">${repeatQtt}</span></p>`;

            if (notMatchArr.length > 1) { // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–Ω–∞ –Ω–µ—Å–æ–≤–ø–∞–≤—à–∞—è —Å—Ç—Ä–æ–∫–∞
                noMatchBtn.style.display = "block";
                noMatchBtn.onclick = () => {
                    console.log(`üìÇ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª —Å –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏...`);
                    const noMatchWorkbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(
                        noMatchWorkbook,
                        XLSX.utils.aoa_to_sheet(notMatchArr),
                        "No Matches"
                    );
                    XLSX.writeFile(noMatchWorkbook, "noMatch.xlsx");
                    console.log(`‚úÖ –§–∞–π–ª noMatch.xlsx —Å–æ—Ö—Ä–∞–Ω–µ–Ω.`);
                };
            }

            fileNameInput.value = "";
            inputFFSearchRepeat.value = "";
            inputSFSearchRepeat.value = "";

        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", error);
            loading.innerHTML = "<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤!</p>";
        }
    }

    loadBtnSearchRepeat.addEventListener("click", processFiles);

    // –û–±. –ø–æ–≤—Ç–æ—Ä–æ–≤ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
    const inputFileMergeVert = document.getElementById("inputFileMergeVert");
    const loadBtnMergeVert = document.querySelector(".load-button-merge-vert");
    const loadingMergeVert = document.querySelector(".loadingMergeVert");
    const fileNameInputMVert = document.querySelector("#fileNameMergeVert");
    const formMergeVert = document.querySelector(".mergeVertical");

    function createMsg(msg) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("msgDiv");
        const mesPar = document.createElement("p");
        mesPar.textContent = msg;
        msgDiv.appendChild(mesPar);
        formMergeVert.appendChild(msgDiv);
    }

    loadBtnMergeVert.addEventListener("click", async () => {
        const fileName = fileNameInputMVert.value;
        if (!inputFileMergeVert.files[0]) return;

        loading.innerHTML = "<h2>–û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•...</h2>";

        const dataArrFirstFile = await readXlsxFile(inputFileMergeVert.files[0]);
        const headers = dataArrFirstFile.shift();

        let aggregatedData = new Map();
        dataArrFirstFile.forEach(row => {
          const id = row[0];
          if (!aggregatedData.has(id)) {
            aggregatedData.set(id, row.slice());
          } else {
            let existingRow = aggregatedData.get(id);
            for (let i = 1; i < row.length; i++) {
              existingRow[i] = (existingRow[i] || 0) + (row[i] || 0);
            }
          }
        });

        const finalData = [headers, ...Array.from(aggregatedData.values())];
        await writeXlsxFile(finalData.map(row => row.map(value => ({ value }))), {
          fileName: `${fileName}.xlsx`,
        });

        loadingMergeVert.innerHTML = "";
        fileNameInputMVert.value = "";
        inputFileMergeVert.value = ""
    });

    // –û–±. –ø–æ–≤—Ç–æ—Ä–æ–≤ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏

    const inputFileMergeVertC = document.getElementById("inputFileMergeVertC");
    const inputMergeVertCStart = document.getElementById("inputColSum");
    const inputMergeVertCEnd = document.getElementById("inputColSumEnd");
    const loadBtnMergeVertC = document.querySelector(".load-button-merge-vert-c");
    const loadingMergeVertC = document.querySelector(".loadingMergeVertC");
    const fileNameInputMergeVertC = document.querySelector("#fileNameMergeVertC");
    const form = document.querySelector("form");

      let dataArrFirstFile = [];
      let dataArrSecondFile = [];

      function createMsg(msg) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("msgDiv");
        const mesPar = document.createElement("p");
        mesPar.textContent = msg;
        msgDiv.appendChild(mesPar);
        form.appendChild(msgDiv);
      }

      loadBtnMergeVertC.addEventListener("click", async () => {
        let flagMsg = 0;
        const colSum = inputMergeVertCStart.value;
        const colSumEnd = inputMergeVertCEnd.value;
        const msgAlertDiv = document.querySelector(".msgDiv");
        if (msgAlertDiv) {
          msgAlertDiv.remove();
        }
        if (
          colSum < 2 ||
          colSumEnd < 2 ||
          colSumEnd < colSum ||
          colSum === "" ||
          colSumEnd === ""
        ) {
          createMsg("–ù–ï –ö–û–†–†–ï–ö–¢–ù–û –£–ö–ê–ó–ê–ù–´ –ì–†–ê–ù–ò–¶–´ –°–£–ú–ú–ò–†–û–í–ê–ù–ò–Ø");
          flagMsg = 1;
        }
        const fileName = fileNameInputMergeVertC.value;
        if (fileName === "") {
          if (flagMsg === 0) {
            createMsg("–ù–ï –£–ö–ê–ó–ê–ù–ù–û –ò–ú–Ø –§–ê–ô–õ–ê");
          }
          return;
        }
        if (!inputFileMergeVertC.files[0]) {
          return;
        }

        loadingMergeVertC.innerHTML = "<h2>–û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•...</h2>";
        readXlsxFile(inputFileMergeVertC.files[0])
          .then((rowsData) => {
            dataArrFirstFile = rowsData;
            return dataArrFirstFile;
          })
          .then((dataArrFirstFile) => {
            const headRow = dataArrFirstFile.shift();
            // console.log(headRow);
            dataArrFirstFile.sort((val1, val2) => {
              if (val1 < val2) {
                return -1;
              }
              if (val1 > val2) {
                return 1;
              }
              return 0;
            });

            for (let i = 0; i < dataArrFirstFile.length - 1; i++) {
              if (dataArrFirstFile[i][0] !== null) {
                if (dataArrFirstFile[i][0] === dataArrFirstFile[i + 1][0]) {
                  for (let j = colSum - 1; j < colSumEnd; j++) {
                    dataArrFirstFile[i][j] =
                      Number(dataArrFirstFile[i][j]) +
                      Number(dataArrFirstFile[i + 1][j]);
                  }
                  dataArrFirstFile.splice(i + 1, 1);
                  i--;
                }
              }
            }
            let readyArr = [];

            dataArrFirstFile.forEach((elem) => {
              let innerArr = [];
              elem.forEach((el) => {
                innerArr.push({ value: el });
              });
              readyArr.push(innerArr);
            });
            const finalHeadRow = [];
            headRow.forEach((el) => {
              finalHeadRow.push({ value: el });
            });
            readyArr.unshift(finalHeadRow);
            return readyArr;
          })
          .then(async (readyData) => {
            // console.log("---->", readyData);
            await writeXlsxFile(readyData, {
              fileName: `${fileName}.xlsx`,
            });
            loadingMergeVertC.innerHTML = "";
            fileNameInputMergeVertC.value = "";
            inputFileMergeVertC.value = "";
          });
      });

      // –û–±. –ø–æ–≤—Ç–æ—Ä–æ–≤ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
      const inputFileCtr = document.getElementById("inputFileCtrA");
      const inputCtrStart = document.getElementById("inputColSumCtr");
      const inputCtrEnd = document.getElementById("inputColSumCtrEnd");
      const loadBtnCtr = document.querySelector(".load-button-ctr");
    //   const loading = document.querySelector(".loading");
      const fileNameInputCtr = document.querySelector("#fileNameCtr");
      const formCtr = document.querySelector(".ctrAsnalytics");

      let dataArrFirstFileCtr = [];
      let dataArrSecondFileCtr = [];

      const colSumInput = document.getElementById("inputColSumCtr");
      const colSumEndInput = document.getElementById("inputColSumCtrEnd");
      const COL_SUM_KEY = "colSumValue";
      const COL_SUM_END_KEY = "colSumEndValue";

      // Function to save values to local storage
      function saveToLocalStorage(key, value) {
        localStorage.setItem(key, value);
      }

      // Function to load values from local storage and set them into inputs
      function loadFromLocalStorage() {
        const colSumValue = localStorage.getItem(COL_SUM_KEY);
        const colSumEndValue = localStorage.getItem(COL_SUM_END_KEY);

        if (colSumValue !== null) {
          colSumInput.value = colSumValue;
        }

        if (colSumEndValue !== null) {
          colSumEndInput.value = colSumEndValue;
        }
      }

      // Event listeners for input changes to update local storage
      colSumInput.addEventListener("input", function () {
        // Ensure the value is not less than 0
        if (colSumInput.value < 0) {
          colSumInput.value = 0;
        }

        // Update local storage
        saveToLocalStorage(COL_SUM_KEY, colSumInput.value);

        // Ensure colSumEndInput is not smaller than colSumInput
        if (parseFloat(colSumEndInput.value) < parseFloat(colSumInput.value)) {
          colSumEndInput.value = colSumInput.value;
          saveToLocalStorage(COL_SUM_END_KEY, colSumEndInput.value);
        }
      });

      colSumEndInput.addEventListener("input", function () {
        // Ensure the value is not less than 0
        if (colSumEndInput.value < 0) {
          colSumEndInput.value = 0;
        }

        // Update local storage
        saveToLocalStorage(COL_SUM_END_KEY, colSumEndInput.value);

        // Ensure colSumEndInput is not smaller than colSumInput
        if (parseFloat(colSumEndInput.value) < parseFloat(colSumInput.value)) {
          colSumEndInput.value = colSumInput.value;
          saveToLocalStorage(COL_SUM_END_KEY, colSumEndInput.value);
        }
      });

      // Load stored values when the page loads
      document.addEventListener("DOMContentLoaded", loadFromLocalStorage);

      function getFormattedDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");

        return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}`;
      }

      function createMsg(msg) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("msgDiv");
        const mesPar = document.createElement("p");
        mesPar.textContent = msg;
        msgDiv.appendChild(mesPar);
        formCtr.appendChild(msgDiv);
      }

      document.getElementById("inputColSum").addEventListener("input", function () {
        const colSumInput = document.getElementById("inputColSum");
        const colSumEndInput = document.getElementById("inputColSumEnd");

        // Ensure the value is not less than 0
        if (colSumInput.value < 0) {
          colSumInput.value = 0;
        }

        // Ensure colSumEndInput is not smaller than colSumInput
        if (parseFloat(colSumEndInput.value) < parseFloat(colSumInput.value)) {
          colSumEndInput.value = colSumInput.value;
        }
      });

      document.getElementById("inputColSumEnd").addEventListener("input", function () {
        const colSumInput = document.getElementById("inputColSum");
        const colSumEndInput = document.getElementById("inputColSumEnd");

        // Ensure the value is not less than 0
        if (colSumEndInput.value < 0) {
          colSumEndInput.value = 0;
        }

        // Ensure colSumEndInput is not smaller than colSumInput
        if (parseFloat(colSumEndInput.value) < parseFloat(colSumInput.value)) {
          colSumEndInput.value = colSumInput.value;
        }
      });


      loadBtnCtr.addEventListener("click", async () => {
        console.log("1111111111")
        let flagMsg = 0;
        const colSum = 2;
        const colSumEnd = 5;
        const msgAlertDiv = document.querySelector(".msgDiv");
        if (msgAlertDiv) {
          msgAlertDiv.remove();
        }
        if (
          colSum < 2 ||
          colSumEnd < 2 ||
          colSumEnd < colSum ||
          colSum === "" ||
          colSumEnd === ""
        ) {
          createMsg("–ù–ï –ö–û–†–†–ï–ö–¢–ù–û –£–ö–ê–ó–ê–ù–´ –ì–†–ê–ù–ò–¶–´ –°–£–ú–ú–ò–†–û–í–ê–ù–ò–Ø");
          flagMsg = 1;
        }
        const fileName = fileNameInputCtr.value;
        // if (fileName === "") {
        //   if (flagMsg === 0) {
        //     createMsg("–ù–ï –£–ö–ê–ó–ê–ù–ù–û –ò–ú–Ø –§–ê–ô–õ–ê");
        //   }
        //   return;
        // }
        if (!inputFileCtr.files[0]) {
          return;
        }

        loading.innerHTML = "<h2>–û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•...</h2>";
        readXlsxFile(inputFileCtr.files[0])
          .then((rowsData) => {
            dataArrFirstFileCtr = rowsData;
            return dataArrFirstFileCtr;
          })
          .then((dataArrFirstFile) => {
            const headRow = dataArrFirstFile.shift();
            // console.log(headRow);
            dataArrFirstFileCtr.sort((val1, val2) => {
              if (val1 < val2) {
                return -1;
              }
              if (val1 > val2) {
                return 1;
              }
              return 0;
            });

            for (let i = 0; i < dataArrFirstFileCtr.length - 1; i++) {
              if (dataArrFirstFileCtr[i][0] !== null) {
                if (dataArrFirstFileCtr[i][0] === dataArrFirstFileCtr[i + 1][0]) {
                  for (let j = colSum - 1; j < colSumEnd; j++) {
                    dataArrFirstFileCtr[i][j] =
                      Number(dataArrFirstFileCtr[i][j]) +
                      Number(dataArrFirstFileCtr[i + 1][j]);
                  }
                  dataArrFirstFileCtr.splice(i + 1, 1);
                  i--;
                }
              }
            }
            let readyArr = [];

            dataArrFirstFileCtr.forEach((elem) => {
              let innerArr = [];
              elem.forEach((el) => {
                innerArr.push({ value: el });
              });
              readyArr.push(innerArr);
            });

            ////---
            readyArr.forEach((elem, ind) => {
                const num = Number(parseFloat(((elem[2].value / elem[1].value) * 100).toFixed(2)));
                if (inputCtrStart.value && inputCtrEnd.value) {
                  if (num < inputCtrStart.value) {
                    elem[3] = {value: num, fontWeight: "bold", backgroundColor: "#ff7c80"};
                    elem[4] = {value: "–ù–∏–∑–∫–∏–π CTR"};
                  } else if ((num >= inputCtrEnd.value)) {
                    elem[3] = {value: num, fontWeight: "bold", backgroundColor: "#a9d08e"};
                    elem[4] = {value: "–í—ã—Å–æ–∫–∏–π CTR"};
                  } else {
                    elem[3] = {value: num, fontWeight: "bold"};
                    elem[4] = {value: ""};
                  }
                } else if (inputCtrStart.value) {
                    if (num < inputCtrStart.value) {
                      elem[3] = {value: num, fontWeight: "bold", backgroundColor: "#ff7c80"};
                      elem[4] = {value: "–ù–∏–∑–∫–∏–π CTR"};
                    } else {
                      elem[3] = {value: num, fontWeight: "bold"};
                      elem[4] = {value: ""};
                    }
                } else if (inputCtrEnd.value) {
                    if (num >= inputCtrEnd.value) {
                      elem[3] = {value: num, fontWeight: "bold", backgroundColor: "#a9d08e"};
                      elem[4] = {value: "–í—ã—Å–æ–∫–∏–π CTR"};
                    } else {
                      elem[3] = {value: num, fontWeight: "bold"};
                      elem[4] = {value: ""};
                    }
                } else {
                  elem[3] = {value: num, fontWeight: "bold"};
                }
                
                if (inputCtrStart.value || inputCtrEnd.value) {
                  elem.splice(5);
                } else {
                  elem.splice(4);
                }
                
            });
            readyArr.sort((a, b) => b[1].value - a[1].value);

            ////---

            const finalHeadRow = [];
            headRow.forEach((el, ind) => {
              if (ind < 4) {
                finalHeadRow.push({ value: el });
              } else if ((inputCtrStart.value || inputCtrEnd.value) && ind == 4) {
                finalHeadRow.push({ value: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" });
              }
            });
            readyArr.unshift(finalHeadRow);
            return readyArr;
          })
          .then(async (readyData) => {
            // console.log("---->", readyData);
            if(fileName) {
              await writeXlsxFile(readyData, {
              fileName: `${fileName}.xlsx`,
            });
            } else {
              await writeXlsxFile(readyData, {
              fileName: `keywords-${getFormattedDate()}.xlsx`,
            });
            }
            fileNameInputCtr.value = "";
            // loading.innerHTML = "";
            inputFileCtr.value = "";          });
      });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
<script src="https://unpkg.com/write-excel-file@1.x/bundle/write-excel-file.min.js"></script> 
</body>
</html>